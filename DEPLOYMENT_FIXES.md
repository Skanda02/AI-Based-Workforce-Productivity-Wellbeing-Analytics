# Deployment Fixes - FastAPI on Render

## Issues Fixed

### 1. **FastAPI ASGI/WSGI Incompatibility Error**

**Error:**
```
TypeError: FastAPI.__call__() missing 1 required positional argument: 'send'
```

**Cause:** Gunicorn was using the default `sync` worker which is a WSGI worker, but FastAPI is an ASGI application.

**Solution:** Updated the start command in `render.yaml` to use Gunicorn with Uvicorn worker class:

```yaml
startCommand: cd api && gunicorn main:app -k uvicorn.workers.UvicornWorker --bind 0.0.0.0:$PORT --workers 1 --timeout 120 --log-level info
```

**Key Changes:**
- Changed from `--worker-class` to `-k` flag (shorter form)
- Specified `uvicorn.workers.UvicornWorker` as the worker class
- Set workers to 1 (recommended for free tier to avoid memory issues)
- Added timeout of 120 seconds
- Ensured proper log output

---

### 2. **Database Tables Not Created (SQLAlchemy Errors)**

**Error:**
```
SQLAlchemy relation "oauth_tokens" does not exist
```

**Cause:** Database tables were not being created on deployment. The `Base.metadata.create_all()` was commented out in main.py.

**Solution:** 
1. Created `api/init_db.py` - Database initialization script that creates all tables
2. Updated `render.yaml` buildCommand to run `python init_db.py` during deployment
3. Added fallback table creation in `main.py` lifespan manager (belt and suspenders)
4. Created `api/setup_db.sh` - Helper script for local development

**Database Tables Created:**
- `users` - User accounts
- `oauth_tokens` - OAuth access/refresh tokens (encrypted)
- `data_fetches` - Track data fetch operations
- `features` - Extracted ML features
- `wellbeing_scores` - Computed wellbeing scores
- `employee_attendance` - Login/logout tracking
- `overtime_tracker` - Overtime monitoring
- `alerts` - Alert notifications
- `manager_actions` - Manager action tracking
- `manager_penalties` - Manager penalty tracking
- `wellbeing_feedback` - Team feedback
- `team_wellbeing_checks` - Scheduled check-ins
- `team_members` - Team membership

**Local Development Setup:**
```bash
cd api

# Method 1: Direct script
export DATABASE_URL="postgresql://user:pass@localhost:5432/dbname"
python init_db.py

# Method 2: Helper script (recommended)
./setup_db.sh

# Method 3: Reset database (WARNING: Deletes all data!)
python init_db.py --reset
```

**Manual Database Reset:**
```bash
python init_db.py --drop  # Drop all tables
python init_db.py         # Recreate tables
```

---

### 3. **OAuth Redirect URI Configuration**

**Issue:** OAuth redirect URIs were hardcoded to `localhost:8000`, causing OAuth failures in production.

**Solution:** 
1. Added `BASE_URL` setting to config.py
2. Created `get_redirect_uri()` method that dynamically constructs redirect URIs
3. Updated all OAuth integrations to use dynamic redirect URIs

**Files Modified:**
- `api/config.py` - Added BASE_URL and get_redirect_uri() method
- `api/integrations/microsoft.py` - Uses dynamic redirect URI
- `api/integrations/slack.py` - Uses dynamic redirect URI
- `api/integrations/github.py` - Uses dynamic redirect URI
- `api/integrations/google_sheets.py` - Uses dynamic redirect URI

---

## Environment Variables to Set on Render

In your Render dashboard, add these environment variables:

```bash
# Base URL (CRITICAL - Set to your production URL)
BASE_URL=https://ai-based-workforce-productivity-yq1s.onrender.com

# CORS Origins (include your frontend URL)
CORS_ORIGINS=https://your-frontend-url.onrender.com,http://localhost:5173

# Database (REQUIRED - Create a PostgreSQL database in Render)
DATABASE_URL=<your-postgres-url-from-render>

# Security (Auto-generated by Render - or set manually)
SECRET_KEY=<auto-generated-or-your-secret-key>
JWT_SECRET_KEY=<auto-generated-or-your-secret-key>

# OAuth Providers (add as needed)
MICROSOFT_CLIENT_ID=<your-client-id>
MICROSOFT_CLIENT_SECRET=<your-client-secret>

SLACK_CLIENT_ID=<your-client-id>
SLACK_CLIENT_SECRET=<your-client-secret>

GITHUB_CLIENT_ID=<your-client-id>
GITHUB_CLIENT_SECRET=<your-client-secret>

GOOGLE_CLIENT_ID=<your-client-id>
GOOGLE_CLIENT_SECRET=<your-client-secret>

# Optional
ENCRYPTION_KEY=<generate-with-fernet>
TEST_MODE=false
```

---

## Creating PostgreSQL Database on Render

1. **Go to Render Dashboard** â†’ New â†’ PostgreSQL
2. **Create database:**
   - Name: `workforce-wellbeing-db`
   - Database: `wellbeing_db`
   - User: `wellbeing_user`
   - Region: Same as your API (oregon)
   - Plan: Free tier (or paid for production)

3. **Copy Internal Database URL** after creation
4. **Set in your API service:**
   - Go to your web service â†’ Environment
   - Add: `DATABASE_URL` = `<internal-database-url>`

5. **Tables will be created automatically** when you deploy (via buildCommand)

---

## How to Update OAuth Provider Redirect URIs

After deploying, you need to update the redirect URIs in your OAuth provider consoles:

### Microsoft Azure AD
1. Go to Azure Portal â†’ App Registrations
2. Select your app â†’ Authentication
3. Add redirect URI: `https://ai-based-workforce-productivity-yq1s.onrender.com/auth/microsoft/callback`

### Slack
1. Go to api.slack.com/apps
2. Select your app â†’ OAuth & Permissions
3. Add redirect URL: `https://ai-based-workforce-productivity-yq1s.onrender.com/auth/slack/callback`

### GitHub
1. Go to GitHub Settings â†’ Developer settings â†’ OAuth Apps
2. Select your app
3. Update Authorization callback URL: `https://ai-based-workforce-productivity-yq1s.onrender.com/auth/github/callback`

### Google Cloud Console
1. Go to Google Cloud Console â†’ APIs & Services â†’ Credentials
2. Select your OAuth 2.0 Client ID
3. Add Authorized redirect URI: `https://ai-based-workforce-productivity-yq1s.onrender.com/auth/google/callback`

---

## Deployment Steps

### 1. Commit and Push Changes

```bash
git add .
git commit -m "Fix ASGI deployment, database initialization, and OAuth URIs"
git push origin main
```

### 2. Set Up PostgreSQL Database on Render

- Create PostgreSQL database in Render dashboard
- Copy the Internal Database URL
- Keep it handy for next step

### 3. Configure Environment Variables

Go to your web service in Render â†’ Environment and add:
- `DATABASE_URL` - From step 2
- `BASE_URL` - Your Render app URL
- `CORS_ORIGINS` - Include your frontend URL
- OAuth credentials (Google, Microsoft, etc.)

### 4. Render Will Auto-Deploy

- Monitor deployment logs
- Look for "ðŸ”§ Creating database tables..."
- Look for "âœ… Database tables created successfully!"
- Look for "ðŸš€ Starting Workforce Wellbeing Analytics API"

### 5. Update OAuth Provider Redirect URIs

Update each OAuth provider with your production callback URL (see above)

### 6. Test the Deployment

```bash
# Test API is running
curl https://ai-based-workforce-productivity-yq1s.onrender.com/

# Test health endpoint
curl https://ai-based-workforce-productivity-yq1s.onrender.com/health

# Response should be:
# {"status": "healthy", "database": "connected", ...}
```

---

## Alternative Deployment Options

### Option 1: Use Uvicorn Directly (Simpler)
If you prefer not to use Gunicorn:

```yaml
startCommand: cd api && python -m uvicorn main:app --host 0.0.0.0 --port $PORT
```

**Pros:** Simpler, fewer dependencies  
**Cons:** Only one worker process, less scalable

### Option 2: Use Gunicorn with Multiple Workers (Production)
For paid plans with more resources:

```yaml
startCommand: cd api && gunicorn main:app -k uvicorn.workers.UvicornWorker --bind 0.0.0.0:$PORT --workers 4 --timeout 120
```

**Pros:** Better performance, handles more concurrent requests  
**Cons:** Uses more memory (not suitable for free tier)

---

## Troubleshooting

### If you still see the ASGI error:
1. Check that `uvicorn[standard]>=0.24.0` is in requirements.txt
2. Verify build logs show uvicorn being installed
3. Try the simple Uvicorn option (Option 1 above)

### If database tables aren't created:
1. Check build logs for "ðŸ”§ Creating database tables..."
2. Verify DATABASE_URL is set correctly in environment variables
3. Check PostgreSQL database is running and accessible
4. Try manually running:
   ```bash
   # In Render shell
   cd api && python init_db.py
   ```

### If OAuth still fails:
1. Verify BASE_URL is set correctly in Render environment variables
2. Check that redirect URIs are updated in OAuth provider consoles
3. Ensure they match exactly (including https://)
4. Check application logs for detailed error messages

### If database connection fails:
1. Verify DATABASE_URL is set correctly
2. Use **Internal Database URL** from Render PostgreSQL (not external)
3. For PostgreSQL, ensure connection uses SSL if required
4. Check database is in same region as API for better performance

### Database Connection Test:
```bash
# In Render shell or locally
python -c "
from api.database import SessionLocal, User
db = SessionLocal()
print(f'Users: {db.query(User).count()}')
db.close()
"
```

---

## Files Created/Modified

### New Files:
1. `api/init_db.py` - Database initialization script
2. `api/setup_db.sh` - Local database setup helper
3. `api/Procfile` - Backup deployment config
4. `api/runtime.txt` - Python version specification
5. `DEPLOYMENT_FIXES.md` - This documentation

### Modified Files:
1. `render.yaml` - Updated build/start commands with database init
2. `api/requirements.txt` - Added version constraints
3. `api/config.py` - Added BASE_URL and dynamic redirect URI support
4. `api/main.py` - Re-enabled database table creation in lifespan
5. `api/integrations/microsoft.py` - Dynamic redirect URI
6. `api/integrations/slack.py` - Dynamic redirect URI
7. `api/integrations/github.py` - Dynamic redirect URI
8. `api/integrations/google_sheets.py` - Dynamic redirect URI
9. `api/.env.example` - Updated with BASE_URL and dynamic URI notes

---

## Next Steps

1. âœ… Deploy the changes
2. âœ… Create PostgreSQL database on Render
3. âœ… Set DATABASE_URL and BASE_URL environment variables
4. âœ… Update OAuth provider redirect URIs
5. âœ… Test endpoints and OAuth flows
6. âœ… Monitor logs for any issues

---

## Support

If you encounter any issues:
1. Check Render deployment logs (Build & Deploy tab)
2. Check application logs (Logs tab)
3. Verify all environment variables are set correctly
4. Test database connection separately
5. Check OAuth provider configurations match redirect URIs
6. Use curl or Postman to test endpoints

---

## Quick Reference

### Essential Render Environment Variables:
```
DATABASE_URL=<from-render-postgres>
BASE_URL=https://your-app.onrender.com
CORS_ORIGINS=https://your-frontend.com
GOOGLE_CLIENT_ID=<your-id>
GOOGLE_CLIENT_SECRET=<your-secret>
SECRET_KEY=<generate-random>
```

### Test Commands:
```bash
# Test API
curl https://your-app.onrender.com/

# Test health
curl https://your-app.onrender.com/health

# Test database (in Render shell)
cd api && python -c "from database import SessionLocal; db = SessionLocal(); db.execute('SELECT 1'); print('OK')"
```

### Useful Render Commands:
```bash
# SSH into your service
render ssh

# View logs
render logs

# Restart service
render restart
```
